@model IEnumerable<Pocket.Models.Expense>

@{
    ViewBag.Title = "List";
}

<link href="~/Content/ui.jqgrid.css" rel="stylesheet" />
<link href="~/Content/themes/redmond/jquery.ui.datepicker.css" rel="stylesheet" />
<link href="~/Content/themes/redmond/jquery.ui.dialog.css" rel="stylesheet" />

<script src="~/Scripts/grid.locale-en.js"></script>
<script src="~/Scripts/jquery.jqGrid.src.js"></script>
<script src="~/Scripts/QIE/JqGrid.js"></script>
<script src="~/Scripts/QIE/DatePickerReady.js"></script>

<br />
<p>
    Expense From:
    @Html.TextBox("ExpenseFrom", new DateTime(DateTime.Now.Year, DateTime.Now.Month, 1).ToShortDateString()) To: 
    @Html.TextBox("ExpenseTo", DateTime.Now.ToShortDateString()) 
    <a href="#" onclick="ReloadGrid()">Reload</a>
</p>

<table id="rowed2"></table>
<div id="prowed2"></div>
<div>
    @Html.AntiForgeryToken()
</div>
<script type="text/javascript">
    $(document).ready(function () {
       
        $(function () {
            $("#ExpenseFrom").datepicker();
        });
        $(function () {
            $("#ExpenseTo").datepicker();
        });
    });

    function ReloadGrid()
    {
        jQuery("#rowed2").jqGrid().trigger("reloadGrid");
    }

    var colNames = ['ExpenseID', 'Expense Date', 'Category', 'Account', 'Amount','Description', 'Payee', 'Vendor', 'Event', 'Comments', 'Repeat'];
    var colModel = [
        { name: 'ExpenseID', index: 'ExpenseID', width: 55, key: true, hidden: true },
       {
           name: 'ExpenseDate', index: 'ExpenseDate', width: 100, editable: true, sorttype: "date", datefmt: 'mm/dd/yyyy', editoptions: {
               dataInit: function (el) {
                   $(el).datepicker({ dateFormat: 'mm/dd/yy' });
               },
               
           },
           editrules: { required: true, date: true }
       },
        { name: 'SubcategoryID', index: 'SubcategoryID', width: 100, editable: true, edittype: 'select', editoptions: {dataUrl: '/category/JCategories' } },
        { name: 'AccountID', index: 'AccountID', width: 100, editable: true, edittype: 'select', editoptions: {dataUrl: '/qaccount/JAccounts' } },
        { name: 'Amount', index: 'Amount', width: 100, editable: true,sorttype:'number',formatter:'number',summaryType:'sum', editrules: { required: true, number: true } },
        { name: 'Description', index: 'Description', width: 100, editable: true, edittype: "textarea", editoptions: { rows: "3", cols: "25" } },
    { name: 'PayeeID', index: 'PayeeID', width: 100, editable: true, edittype: 'select', editoptions: { dataUrl: '/payee/JPayees' } },

        { name: 'VendorID', index: 'VendorID', width: 100, editable: true, edittype: 'select', editoptions: { dataUrl: '/vendor/JVendors' } },
    { name: 'EventID', index: 'EventID', width: 100, editable: true, edittype: 'select', editoptions: { dataUrl: '/event/JEvents' } },
    { name: 'Comments', index: 'Comments', width: 100, editable: false, formatter: CommentFormatter },
    { name: 'Repeat', index: 'Repeat', width: 100, editable: true, edittype: 'select', editrules: { required: false, select: true }, editoptions: { dataUrl: '/api/common/RecursionOptions' } }
    ];

    var postData = {};
    postData["ExpenseFrom"] = function () { return $("#ExpenseFrom").val() };
    postData["ExpenseTo"] = function () { return $("#ExpenseTo").val(); };

    createJQGrid('/expense/jlist', colNames, colModel, 'ExpenseID', "/expense/jedit", "Expense List", "#rowed2", '#prowed2', postData, { sidx: 'ExpenseDate', sord: 'desc' });

    /////////////////////
    //   Expense Comments
    ///////////////////////

    function CommentFormatter(cellvalue, options, rowObject) {
        // format the cellvalue to new format

        if (cellvalue && cellvalue.length > 0) {
            var tag = "<a href='#' onclick='ShowComments(" + rowObject[0] + ")'>" + cellvalue + "</a>";
            return tag;
        }
        else
            return "<label></label>";

    }

    function ShowComments(expenseID) {
        $("#hdnExpenseID").val(expenseID);

        if (firsttime)
        {
            dialog = $("#commentsDialog").dialog({
                autoOpen: false,
                height: 400,
                width: 450,
                show: {
                    effect: "blind",
                    duration: 1000
                }
            });
            dialog.dialog("open");
            var commPostData = {};
            commPostData["ExpenseID"] = function () { return $("#hdnExpenseID").val() };

            createJQGrid('/expense/JExpenseComments', commColNames, commColModel, 'CommentID', "/expense/jcommentedit", "Add/View Comments", "#lstComments", '#pgrComments', commPostData, { sidx: 'CommentID', sord: 'desc',editgrid:false, editExtraParams: { ExpenseID: function () { return $("#hdnExpenseID").val() } } });
            firsttime = false;
        }
        dialog.dialog("open");
        jQuery("#lstComments").jqGrid().trigger("reloadGrid");
        // $(".ui-dialog-titlebar").hide();
        //$("#lstComments > .ui-jqgrid-titlebar").hide();
        //$('.ui-jqgrid-hdiv').hide();
    }
    var commColNames = ['CommentID','ExpenseID', 'Comment', 'By', 'Date'];
    var commColModel = [
        { name: 'CommentID', index: 'CommentID', width: 55, key: true, hidden: true },
        { name: 'ExpenseID', index: 'ExpenseID', width: 55, hidden: true },
        { name: 'Comment', index: 'Comment', width: 155, key: true, editable: true, edittype: "textarea", editoptions: { rows: "3", cols: "25" } },
        { name: 'UserID', index: 'UserID', width: 55, editable: false },
        { name: 'CommentDate', index: 'CommentDate', width: 55, editable: false }
    ];
    var firsttime = true;
    var dialog;

    </script>
<input type="hidden" id="hdnExpenseID"/>
<div id="commentsDialog" title="Comments">
    <table id="lstComments" style="height:100%"></table>
    <div id="pgrComments"></div>

</div>