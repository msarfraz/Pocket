@model IEnumerable<Pocket.Models.Expense>

@{
    ViewBag.Title = "Report By Group";
}

<link href="~/Content/ui.jqgrid.css" rel="stylesheet" />
<link href="~/Content/themes/redmond/jquery.ui.datepicker.css" rel="stylesheet" />
<link href="~/Content/bootstrap-select.min.css" rel="stylesheet" />

<script src="~/Scripts/grid.locale-en.js"></script>
<script src="~/Scripts/jquery.jqGrid.min.js"></script>
<script src="~/Scripts/QIE/JqGrid.js"></script>
<script src="~/Scripts/QIE/DatePickerReady.js"></script>
<script src="~/Scripts/bootstrap-select.min.js"></script>

<p>
    
    <div class="row">
        <div class="col-xs-4">
            <div class="input-group">
                <span class="input-group-addon">Group By:</span>
                <select name="ddlgroup" id="ddlgroup" onchange="LoadReport()" class="form-control">
                    <option value="" label="None" selected="selected" />
                    <option value="AccountID" label="Account" />
                    <option value="ExpenseDate" label="Date"  />
                    <option value="EventID" label="Event" />
                    <option value="PayeeID" label="Payee" />
                    <option value="VendorID" label="Vendor" />
                </select>
            </div>
        </div>
        <div class="col-xs-4">
            <div class="input-group">
                <span class="input-group-addon">Month:</span>
                <select name="ddlMonth" id="ddlMonth" onchange="ReloadGrid()" class="form-control">
                    <option value="1" label="January" />
                    <option value="2" label="February" />
                    <option value="3" label="March" />
                    <option value="4" label="April" />
                    <option value="5" label="May" />
                    <option value="6" label="June" />
                    <option value="7" label="July" />
                    <option value="8" label="August" />
                    <option value="9" label="September" />
                    <option value="10" label="October" />
                    <option value="11" label="November" />
                    <option value="12" label="December" />
                </select>
            </div>
        </div>
        <div class="col-xs-4">
            <div class="input-group">
                <span class="input-group-addon">Year:</span>
                <select name="ddlYear" id="ddlYear" onchange="ReloadGrid()" class="form-control">
                    @for (int i = 2001; i < 2020; i++)
                    {
                        <option value="@i" label="@i" />
                    }
                </select>
            </div>
        </div>


    </div>

</p>

<table id="rowed2"></table>
<div id="prowed2"></div>
<p>

    <div class="btn-group">
        <div class="btn-group">
            <a href="/Expense/" class="btn btn-default">Simple View</a>
        </div>
        <div class="btn-group">
            <a href="/Report/GroupReport" class="btn btn-primary">Group View</a>
        </div>
        <div class="btn-group">
            <a href="/Report/CategoryReport" class="btn btn-default">Category View</a>
        </div>

        <div class="col-xs-4">

            <div class="input-group">
                <span class="input-group-addon">Choose Columns:</span>
                <select class="selectpicker" multiple data-selected-text-format="count>3" id="pagecolumns" onchange="ShowHideColumn()">
                    <option value="PayeeID">Payee</option>
                    <option value="VendorID">Vendor</option>
                    <option value="EventID">Event</option>
                    <option value="Comments" disabled="disabled">Comments</option>
                    <option value="UserID">User Name</option>
                </select>

            </div>
        </div>
    </div>
</p>
<div>
    @Html.AntiForgeryToken()
</div>
<script type="text/javascript">
    var colNames = ['ExpenseID', 'Group', 'Expense Date', 'Category', 'Account', 'Amount', 'Payee', 'Vendor', 'Event', 'By'];
    var colModel = [
        { name: 'ExpenseID', index: 'ExpenseID', width: 55, key: true, hidden: true },
        { name: 'Group', index: 'Group', width: 200 },
        { name: 'ExpenseDate', index: 'ExpenseDate', width: 100, sorttype: "date", datefmt: 'mm/dd/yyyy'},
        { name: 'SubcategoryID', index: 'SubcategoryID', width: 100},
        { name: 'AccountID', index: 'AccountID', width: 100},
        { name: 'Amount', index: 'Amount', width: 100, sorttype: 'number', formatter: 'number', summaryType: 'sum' },
        { name: 'PayeeID', index: 'PayeeID', width: 100, hidden: true },
        { name: 'VendorID', index: 'VendorID', width: 100, hidden: true },
        { name: 'EventID', index: 'PayeeID', width: 100, hidden: true },
        { name: 'UserID', index: 'UserID', width: 100, hidden: true }

    ];

    function ShowHideColumn() {
        var str = $("#pagecolumns").val();
        SetGridColumns(str);
        setPageSettings(str.join());

    }
    function getPageSettings() {
        PostData("/User/GetPageSettings", {}, function (response) {
            SetGridColumns(response.PageSetting.split(","));
            $("#pagecolumns").selectpicker('val', response.PageSetting.split(","));
        });
    }
    function setPageSettings(psetting) {
        PostData("/User/SetPageSettings", { PageSetting: psetting });
    }
    function SetGridColumns(str) {
        jQuery("#rowed2").jqGrid('hideCol', ["PayeeID", "VendorID", "EventID", "UserID"]);
        jQuery("#rowed2").jqGrid('showCol', str);
        jQuery("#rowed2").setGridWidth($(".container").width() - 5, true);
    }
    function LoadReport()
    {
        var groupingName = document.getElementById("ddlgroup").value;
        if (groupingName) {
            var grouporder = 'asc';
            if (groupingName == "ExpenseDate")
            {
                grouporder = 'desc';
                //$("#rowed2").remapColumns([0,1,2,3,4,5,6,7], true, false);
            }
                
            else
            {
                //$("#rowed2").remapColumns([0,3,1,2,4,5,6,7], true, false);
                //grouporder = 'asc';
            }
                
            $('#rowed2').jqGrid('groupingGroupBy', groupingName, {
                groupOrder: [grouporder],
                groupColumnShow: [true],
                groupCollapse: false,
                hideFirstGroupCol:false
            });
        } else {
            $('#rowed2').jqGrid('groupingRemove');
        }
        ReloadGrid();
        
        //createJQGrid('/report/jcategory', colNames, colModel, 'ExpenseID', "/expense/jedit", "Expense List", "#rowed2", '#prowed2', true, [groupby]);
    }
    function ReloadGrid() {
        jQuery("#rowed2").jqGrid().trigger("reloadGrid");
    }

    $("#ddlMonth").val('@DateTime.Today.Month');
    $("#ddlYear").val('@DateTime.Today.Year');

    var postData = {};
    postData["Month"] = function () { return $("#ddlMonth").val() };
    postData["Year"] = function () { return $("#ddlYear").val(); };

    createJQGrid('/report/JGroupReport', colNames, colModel, 'ExpenseID', "", "Expense List", "#rowed2", '#prowed2',
        postData, { sidx: 'ExpenseDate', sord: 'desc', grouping: true, groupOrder: 'desc', groupField: [], addgrid: false, editgrid: false, footerrow: true, loadComplete: loadCompleteFunc });
    function loadCompleteFunc() {
        var grid = $("#rowed2"),
            sum = grid.jqGrid('getCol', 'Amount', false, 'sum');

        grid.jqGrid('footerData', 'set', { Group: 'Total:', Amount: sum.toFixed(2) });
        getPageSettings();
    }
</script>
