@model IEnumerable<Pocket.Models.Expense>
@using Pocket.Common

@{
    ViewBag.Title = "Categories Report";
}

<link href="~/Content/ui.jqgrid.css" rel="stylesheet" />
<link href="~/Content/themes/redmond/jquery.ui.datepicker.css" rel="stylesheet" />
<link href="~/Content/bootstrap-select.min.css" rel="stylesheet" />

<script src="~/Scripts/grid.locale-en.js"></script>
<script src="~/Scripts/jquery.jqGrid.min.js"></script>
<script src="~/Scripts/QIE/JqGrid.js"></script>
<script src="~/Scripts/QIE/DatePickerReady.js"></script>
<script src="~/Scripts/bootstrap-select.min.js"></script>

<p>
    <div class="row">
        <div class="col-xs-4">
            <div class="input-group">
                <span class="input-group-addon">Month:</span>
                <select name="ddlMonth" id="ddlMonth" onchange="ReloadGrid()" class="form-control">
                    <option value="1" label="January" />
                    <option value="2" label="February" />
                    <option value="3" label="March" />
                    <option value="4" label="April" />
                    <option value="5" label="May" />
                    <option value="6" label="June" />
                    <option value="7" label="July" />
                    <option value="8" label="August" />
                    <option value="9" label="September" />
                    <option value="10" label="October" />
                    <option value="11" label="November" />
                    <option value="12" label="December" />
                </select>
            </div>
        </div>
        <div class="col-xs-4">
            <div class="input-group">
                <span class="input-group-addon">Year:</span>
                <select name="ddlYear" id="ddlYear" onchange="ReloadGrid()" class="form-control">
                    @for (int i = 2001; i < 2020; i++)
                    {
                        <option value="@i" label="@i" />
                    }
                </select>
            </div>
        </div>
        <div class="col-xs-4">
            <div class="input-group">
                <span class="input-group-addon">Show:</span>
                <select name="ddlExpenseDepth" id="ddlExpenseDepth" onchange="ReloadGrid()" class="form-control">
                    <option value="@ExpenseDepth.MyExpenses.GetHashCode()" label="My Expenses" />
                    <option value="@ExpenseDepth.OtherExpensesMySharedCategories.GetHashCode()" label="My Categories" />
                    <option value="@ExpenseDepth.OtherExpensesOtherSharedCategories.GetHashCode()" label="All Categories" />
                </select>
            </div>
        </div>

    </div>
</p>

<table id="rowed2"></table>
<div id="prowed2"></div>
<p>

    <div class="btn-group">
        <div class="btn-group">
            <a href="/Expense/" class="btn btn-default">Simple View</a>
        </div>
        <div class="btn-group">
            <a href="/Report/GroupReport" class="btn btn-default">Group View</a>
        </div>
        <div class="btn-group">
            <a href="/Report/CategoryReport" class="btn btn-primary">Category View</a>
        </div>

        <div class="col-xs-4">

            <div class="input-group">
                <span class="input-group-addon">Choose Columns:</span>
                <select class="selectpicker" multiple data-selected-text-format="count>3" id="pagecolumns" onchange="ShowHideColumn()">
                    <option value="PayeeID">Payee</option>
                    <option value="VendorID">Vendor</option>
                    <option value="EventID">Event</option>
                    <option value="Comments" disabled="disabled">Comments</option>
                    <option value="UserID">User Name</option>
                </select>

            </div>
        </div>
    </div>
</p>
<div>
    @Html.AntiForgeryToken()
</div>
<script type="text/javascript">
    var colNames = ['ExpenseID', 'Expense Date', 'Account', 'Amount','Budget', 'Payee', 'Vendor', 'Event', 'By', 'CatSum'];
    var colModel = [
        { name: 'id', index: 'id', width: 55, key: true, hidden: true },
        { name: 'ExpenseDate', index: 'ExpenseDate', width: 300},
        { name: 'AccountID', index: 'AccountID', width: 100},
        { name: 'Amount', index: 'Amount', width: 100, formatter: CatFormatter, sorttype: 'number', summaryType: 'sum' },
        { name: 'Budget', index: 'Budget', width:100, hidden:true },
        { name: 'PayeeID', index: 'PayeeID', width: 100, hdiden:true },
        { name: 'VendorID', index: 'VendorID', width: 100, hidden:true },
        { name: 'EventID', index: 'EventID', width: 100, hidden: true },
        { name: 'UserID', index: 'UserID', width: 100, hidden:true },
        { name: 'CatSum', index: 'CatSum', width: 100, hidden:true }

    ];

    function ReloadGrid() {
        jQuery("#rowed2").jqGrid().trigger("reloadGrid");
    }
    function CatFormatter(cellvalue, options, rowObject) {
        // format the cellvalue to new format

        if (cellvalue && cellvalue.length > 0) {
            if (rowObject[options.pos + 1] && parseInt(cellvalue) > parseInt(rowObject[options.pos + 1])) //budget
            {
                return "<span style='color:red' title='Budget Amount:" + parseInt(rowObject[options.pos + 1]) + "'>" + cellvalue + "</span>";
            }
            else
            {
                return "<span title='Budget Amount:" + rowObject[options.pos + 1] + "'>" + cellvalue + "</span>";
            }
            
        }
            return cellvalue;

    }
    function ShowHideColumn() {
        var str = $("#pagecolumns").val();
        SetGridColumns(str);
        setPageSettings(str.join());
    }
    function getPageSettings() {
        PostData("/User/GetPageSettings", {}, function (response) {
            SetGridColumns(response.PageSetting.split(","));
            $("#pagecolumns").selectpicker('val', response.PageSetting.split(","));
        });
    }
    function setPageSettings(psetting) {
        PostData("/User/SetPageSettings", { PageSetting: psetting });
    }
    function SetGridColumns(str) {
        jQuery("#rowed2").jqGrid('hideCol', ["PayeeID", "VendorID", "EventID", "UserID"]);
        jQuery("#rowed2").jqGrid('showCol', str);
        jQuery("#rowed2").setGridWidth($(".container").width() - 5, true)
    }
    $("#ddlMonth").val('@DateTime.Today.Month');
    $("#ddlYear").val('@DateTime.Today.Year');
    var postData = {};
    postData["Month"] = function () { return $("#ddlMonth").val() };
    postData["Year"] = function () { return $("#ddlYear").val(); };
    postData["ExpenseDepth"] = function () { return $("#ddlExpenseDepth").val(); };
    /*
    $("#rowed2").jqGrid({
        url: '/report/JCategoryReport',
        datatype: 'json',
        mtype: 'GET',
        colNames: colNames,
        colModel: colModel,
        treeGridModel: 'adjacency',
        height: 'auto',
        rowNum: 10000,
        treeGrid: true,
        ExpandColumn: 'ExpenseDate',
        caption: "TreeGrid Test",
        postData: postData,
        sortname:'SubcategoryID'
    });
    */

    CreateJQGridTree("#rowed2", '/report/JCategoryReport', colNames, colModel, 'ExpenseDate', 'Category List', postData, 'SubcategoryID', loadCompleteFunc);
    function loadCompleteFunc() {
        var grid = $("#rowed2"),
            sum = grid.jqGrid('getCol', 'CatSum', false, 'sum');

        grid.jqGrid('footerData', 'set', { Name: 'Total:', Amount: sum.toFixed(2) });
        getPageSettings();
    }
    //createJQGrid('/report/JCategoryReport', colNames, colModel, '', "", "Expense List", "#rowed2", '#prowed2', postData, { sidx: 'SubcategoryID', addgrid: false, editgrid: false, gridview: false, treeGrid: true });
</script>
